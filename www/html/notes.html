<!DOCTYPE html>
<html>
<head>
    <title>M-Test Acupuncture Application</title>
    
    <script type="text/javascript" charset="utf-8" src="../js/jquery.min.js"></script>
    <script type="text/javascript" charset="utf-8" src="../js/jquery-ui.min.js"></script>
    
    <script type="text/javascript" charset="utf-8" src="../js/cordova-2.2.0.js"></script>
    <script type="text/javascript" charset="utf-8" src="../js/SQLitePlugin.js"></script>
    <script type="text/javascript" charset="utf-8" src="../js/Screenshot.js"></script>
    <script type="text/javascript" charset="utf-8" src="../js/support.js"></script>
    <script type="text/javascript" charset="utf-8" src="../js/db_patient.js"></script>
    <script type="text/javascript" charset="utf-8" src="../js/db_visit.js"></script>
    <script type="text/javascript" charset="utf-8" src="../js/dialogs.js"></script>
    <script type="text/javascript" charset="utf-8" src="../js/data.js"></script>
    
    <link rel="stylesheet" href="../css/style.css" type="text/css" media="all" />
    <link rel="stylesheet" href="../css/movement_dialog.css" type="text/css" media="all" />
    <link rel="stylesheet" href="../css/point_dialog.css" type="text/css" media="all" />
    <link rel="stylesheet" href="../css/patient_info_form.css" type="text/css" media="all" />
    <link rel="stylesheet" href="../css/jquery-ui.css" type="text/css" media="all" />
    
    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1"/>
    <meta name="format-detection" content="telephone=no" />
    
</head>
<body>
    
    
    
  	<div id="YourPageContainer">
        <div class="grid">
            <div class="grid-top_bar">
                <div class="heading-top_spacer">&nbsp;</div>
                <div class="heading-main_part">
                    <div class="heading-top_of_main_part">
                        <div class="heading-vertical_margin">&nbsp;</div>
                        <div class="heading-mtest_label">M-Test Patient Consultation Sheet</div>
                        <div class="heading-mtest_label_right_gutter">&nbsp;</div>
                        <div class="heading-date">
                            <div class="heading-date_label">date: </div>
                            <div id="heading-date_content" class="heading-date_content">&nbsp;</div>
                        </div>
                        <div class="heading-vertical_margin">&nbsp;</div>
                    </div>
                    <div class="heading-horizontal_gutter">&nbsp;</div>
                    <div class="heading-bottom_of_main_part">
                        <div class="heading-vertical_margin">&nbsp;</div>
                        <div class="heading-left_margin">&nbsp;</div>
                        <div class="heading-ratings_explanation">
                            <img src="../images/ratings_explanation.png">
                                </div>
                        <div class="heading-bottom_of_main_part_gutter">&nbsp;</div>
						<div id="patient_info_box" class="heading-patient_information_left_box">
							<div class="heading-patient_information_label">Name: </div><div id="patient_name" class="heading-patient_information_content">&nbsp</div>&nbsp;&nbsp;<div class="heading-patient_information_label">Sex: </div><div id="patient_sex" class="heading-patient_information_content">&nbsp;</div>&nbsp;&nbsp;<div class="heading-patient_information_label">Age: </div><div id="patient_age" class="heading-patient_information_content">&nbsp</div><br/>
							<!--<div class="heading-patient_information_label">Disorder: </div><div id="patient_disorder" class="heading-patient_information_content">&nbsp</div><br/>-->
							<div class="heading-patient_information_label">Chief Complaint: </div><div id="patient_chiefcomplaint" class="heading-patient_information_content">&nbsp</div>
						</div>
                        <div class="heading-bottom_of_main_part_gutter">&nbsp;</div>
                        <div id="q00" class="heading-patient_information_right_box">
                            <div id="q00_pre_m" class="heading-patient_information_right_box_pre"></div>
                            <div id="q00_post_m" class="heading-patient_information_right_box_post"></div>
                        </div>
                        <div class="heading-vertical_margin">&nbsp;</div>
                    </div>
                </div>
                <div class="heading-bottom_spacer">&nbsp;</div>
            </div>
            
            <div class="notes_midsection">
            
                <div class="notes_index_row">Movement Notes List</div>
            
                <script type="text/javascript" charset="utf-8">
                
                    notes = "";
                    
                    //console.log("hurrr ");
                    
                    for (i=0; i < 31; i++) {
                    
                        movement_number = padZeros(i, 2);
                        //alert("movement " + movement_number);
                        //m01_notes
                    
                        if (i == 0) {
                            document.write("<div id=\"notes_label_" + movement_number + "\" class=\"notes_label_even\">Movement " + movement_number + "</div><div id=\"notes_index_00\" class=\"notes_index_row_even\">&nbsp;</div><div class=\"notes_holder_even\" id=\"notes_holder_00\">" + notes + "</div>");
                        }
                        else if (i % 2 == 0) {
                            document.write("<div id=\"notes_label_" + movement_number + "\" class=\"notes_label_even\">Movement " + movement_number + "</div><div id=\"notes_index_" + movement_number + "\" class=\"notes_index_row_even\">&nbsp;</div><div class=\"notes_holder_even\" id=\"notes_holder_" + movement_number + "\">" + notes + "</div>");
                        }
                        else {
                            document.write("<div id=\"notes_label_" + movement_number + "\" class=\"notes_label_odd\">Movement " + movement_number + "</div><div id=\"notes_index_" + movement_number + "\" class=\"notes_index_row_odd\">&nbsp;</div><div class=\"notes_holder_odd\" id=\"notes_holder_" + movement_number + "\">" + notes + "</div>");
                        }
                    
                    }
                    
                </script>
                
            </div>
            
            <div class="grid-bottom_bar">
                <div class="grid-bottom_bar_button_strip">
                    <div id="back_button" class="grid-bottom_bar_button_two">Back</div>
                    <div id="save_button" class="grid-bottom_bar_button_two">Save</div>
                </div>
            </div>
            
        </div>
    </div>

  	<div id="new_notes_movement_dialog" class="movement_dialog" title="Dialog Title" style="display:none">
  		<div id="notes_movement_dialog_header" class="movement_dialog_header">..........</div>
  		<div id="notes_movement_dialog_image" class="movement_dialog_image"></div>
  		<div id="notes_movement_dialog_image_description_container" class="movement_dialog_image_description_container">
  			<div class="movement_dialog_image_description_two">Left Arm</div>
  			<div class="movement_dialog_image_description_two">Right Arm</div>
  		</div>
  		<div id="notes_movement_dialog_score_boxes" class="movement_dialog_score_boxes">
  			<!--<div id="left_pre" class="movement-rating_pre_box_two_wide"></div>
  			<div id="left_post" class="movement-rating_post_box_two_wide"></div>
  			<div id="right_pre" class="movement-rating_pre_box_two_wide"></div>
  			<div id="right_post" class="movement-rating_post_box_two_wide"></div>-->
  		</div>
  		<div class="movement_dialog_notes_box"><textarea autocomplete="off" autocorrect="off" spellcheck="false" name="notes" id="notes_movement_notes" placeholder="Insert notes here" rows="3" onfocus="window.scrollTo(0, 0);"></textarea></div>	
  	</div>


  	<div id="new_point_dialog" class="new_point_dialog" title="Dialog Title" style="display:none">
  		<div id="point_dialog_header" class="point_dialog_header">&nbsp;</div>
  		<div id="point_dialog_image" class="point_dialog_image"><img src="images/LR_GB.png"></div>
  	</div>
    
          
  <!-- Load your app script here. -->
  <script type="text/javascript" charset="utf-8">
      
    function deviceready() {
    
        $("#notes_movement_notes").focus(function(){
            //$(document).scrollTop(currentScrollPosition);
            setTimeout(function(){
                window.scrollTo(0, 0);
                //document.documentElement.scrollTop = 0;
            }, 10);
        });
              
        //Prevent scrolling when dialog pops up
        document.addEventListener('touchmove', function(e) { e.preventDefault(); }, false);

        $("input").live("focus", function(event) {
            //alert("yo");
            window.scrollTo(0, 0);
            document.documentElement.scrollTop = 0;
        });
        
        //Prevents scrolling on click of input box
        $(document).scroll(function(){
            window.scrollTo(0, 0);
            document.documentElement.scrollTop = 0;
        });
    
    
        //console.log("sheet.html window.name = " + window.name);
        visit_id = window.name.substr(0,13);
        //console.log(visit_id);
        patient_id = window.name.substr(16,10);
      	
        fillInPatientInfo(patient_id);
        fillInVisitDate(visit_id);
        outputOverallPostPreToScreen(visit_id);
        outputNotes(visit_id);
        
    
        visit_db = sqlitePlugin.openDatabase(shortName, version, displayName, maxSize);
        visit_db.transaction( function (tx) {
            tx.executeSql("SELECT * FROM visits WHERE id=?;", [visit_id],
                function(transaction, results) {
                    //console.log("New datahandler(): " + results.rows.length + " rows");
                    row = results.rows.item(0);
                    document.getElementById("q00_pre_m").innerText = row['overall_pre'];
                    document.getElementById("q00_post_m").innerText = row['overall_post'];
                },
                function(e){}
            );
        });

        //setTimeout(function(){visit_db.close();}, 250);
        
    	$("#back_button").click(function(event) {
			window.history.back();
        });
        
        $("#save_button").click(function(event) {
            
            var cordovaRef = window.PhoneGap || window.Cordova || window.cordova; // old to new fallbacks
            //console.log(cordovaRef);
            cordovaRef.exec(null, null, "Screenshot", "saveScreenshot", []);
            //console.log("Take screenshot");
            
        });

    	$("#notes_button").click(function(event) {
			//window.history.back();
        });
        
        /*
        NOT WORKING RIGHT NOW -- ENDS UP MAKING A NEW PATIENT RECORD WHEN POPUP DIALOG GETS CLOSED
      	$("#patient_info_box").click(function(event) {
			popUpPatientDialog(1);
        });
        */
        
        //Runs popUpDialog() function below on 1-30 if clicked
		$(".notes_index_row_odd, .notes_index_row_even, .notes_label_odd, .notes_label_even, .notes_holder.odd, .notes_holder_even").click(function(event) {
			//q14 -- notes_index_00
            //console.log("event handler for notes: " + this.id);
            target_id = "q" + this.id.substr(this.id.lastIndexOf("_") + 1, 2);
            //console.log("target = " + target_id);
            //target_id = "q" + this.id.substr(12,2);
            popUpMovementDialogFromNotes(this.className, target_id, visit_id);
        });
    	
        $(".heading-patient_information_right_box").click(function(event) {
            target_id = "q00"; //rigged up to match above procedure call
            popUpMovementDialogFromNotes(this.className, target_id, visit_id);
        });
             

        // ADD EVENTS TO DO START AND FINISH SWIPES
        $('#new_notes_movement_dialog').live("touchstart", function(event) {
            xPos_start = event.originalEvent.touches[0].pageX;
            //console.log("start row xPos: " + xPos_start);
        });
        
        $('#new_notes_movement_dialog').live("touchend", function(event) {
            
            xPos_moving = event.originalEvent.changedTouches[0].pageX;
            xDiff = xPos_moving - xPos_start;
            //console.log("start row xPos: " + xPos_start + " xDiff: " + xDiff);
            
            //var oTable = $('#delete_visit_table').dataTable();
            
            if (xPos_start == 99999) {    
                //console.log("SWIPE FROM LEFT TO RIGHT -- xPos_start = 99999");
                
            }
            else if (xDiff > 125) {
                //console.log("SWIPE FROM LEFT TO RIGHT -- xDiff: " + xDiff);

                var movement_number = $(this).html();
                movement_number = movement_number.substr(movement_number.indexOf("_big.png")-2, 2);
                movement_number_int = parseInt(movement_number);
                var the_id = "q" + movement_number;
                
                prev_movement_number_int = parseInt(movement_number) - 1;
                
                if (movement_number_int == 1) {
                    prev_movement_number_int = 30;
                }
                else if (movement_number_int == 0) {
                    prev_movement_number_int = 0;
                }
                
                prev_movement_number = padZeros(prev_movement_number_int, 2);
                prev_the_id = "q" + prev_movement_number;
                //console.log("mn / vi / ti / pmn = " + movement_number + " " + visit_id + " " + the_id + " " + prev_movement_number);
                saveNotesMovementDialogInfo(movement_number, visit_id, the_id);
                setTimeout(function(){populateNotesMovementDialog(prev_movement_number, visit_id, prev_the_id);},250);
                
            }                    
            else if (xDiff < -125) {
                //console.log("SWIPE FROM RIGHT TO LEFT -- xDiff = " + xDiff);
                
                var movement_number = $(this).html();
                movement_number = movement_number.substr(movement_number.indexOf("_big.png")-2, 2);
                movement_number_int = parseInt(movement_number);
                var the_id = "q" + movement_number;
                
                next_movement_number_int = parseInt(movement_number) + 1;
                
                if (movement_number_int == 30) {
                    next_movement_number_int = 1;
                }
                else if (movement_number_int == 0) {
                    next_movement_number_int = 0;
                }
                
                next_movement_number = padZeros(next_movement_number_int, 2);
                next_the_id = "q" + next_movement_number;
                //console.log("mn / vi / ti / nmn = " + movement_number + " " + visit_id + " " + the_id + " " + next_movement_number);
                saveNotesMovementDialogInfo(movement_number, visit_id, the_id);
                setTimeout(function(){populateNotesMovementDialog(next_movement_number, visit_id, next_the_id);},250);
                
            }
            else {
                //console.log("CLICK");
            }
            
        });   



        var mousedowntime;
        var presstime;
        $(".movement-rating_pre_box_two_wide, .movement-rating_pre_box_three_wide, .movement-rating_pre_box_single, .movement-rating_post_box_two_wide, .movement-rating_post_box_three_wide, .movement-rating_post_box_single").live("touchstart", function() {
            var d = new Date();
            mousedowntime = d.getTime();
        });
        
        $(".movement-rating_pre_box_two_wide, .movement-rating_pre_box_three_wide, .movement-rating_pre_box_single, .movement-rating_post_box_two_wide, .movement-rating_post_box_three_wide, .movement-rating_post_box_single").live("touchend", function() {
            var d = new Date();
            presstime = d.getTime() - mousedowntime;
            if (presstime < 350) {
                var old = this.innerText;
                var mod;
                
                if (old == "" || old == " ") {
                    mod = 0;
                }
                else if (old == 10) {
                    mod = " ";
                }
                else {
                    old++; 
                    mod = old % 11;
                }
                    
                this.innerText = mod;
            }
            else {
                var old = this.innerText; 
                var mod;
                if (old == "" || old == " " || old == null) {
                    mod = "10";
                } 
                else if (old == 0) {
                    mod = " ";
                }
                else {
                    old--;
                    mod = old % 11;
                }
                
                this.innerText = mod;
            }
        });

    }


    function outputNotes(visit_id) {
        //console.log("got here");
        visit_db = sqlitePlugin.openDatabase(shortName, version, displayName, maxSize);
        //console.log("got here 2");
        visit_db.transaction(
            function (tx) {
                tx.executeSql("SELECT * FROM visits WHERE id=?;", [visit_id], DataSelectHandler45, visitErrorHandler);
                //console.log("got here 3");
            }
        );
        //console.log("got here 4");
        
        function DataSelectHandler45(transaction, results) {
            
            //console.log("outputNotes datahandler(): " + results.rows.length + " rows");
            row = results.rows.item(0);
            
            // get overall notes
            // get 1-30 notes
            for (i=0; i <= 30; i++) {
                if (i == 0) {
                    these_notes = row['overall_notes'];
                    a_pre = row['overall_pre'];
                    a_post = row['overall_post'];
                    document.getElementById("notes_label_00").innerText = "Overall Notes";
                    document.getElementById("notes_index_00").innerText = a_pre + "/" + a_post;
                    document.getElementById("notes_holder_00").innerText = these_notes;
                }
                else if (i == 1) {
                    movement_number = padZeros(i, 2);
                    these_notes = row['m' + movement_number + '_notes'];
                    a_pre = row['m' + movement_number + '_pre'];
                    a_post = row['m' + movement_number + '_post'];
                    b_pre = row['m' + movement_number + 'a_pre'];
                    b_post = row['m' + movement_number + 'a_post'];
                    c_pre = row['m' + movement_number + 'b_pre'];;
                    c_post = row['m' + movement_number + 'b_post'];
                    document.getElementById("notes_label_" + movement_number).innerText = "Movement " + movement_number;
                    document.getElementById("notes_index_" + movement_number).innerText = a_pre + "/" + a_post + " " + b_pre + "/" + b_post + " " + c_pre + "/" + c_post;
                    document.getElementById("notes_holder_" + movement_number).innerText = these_notes;
                }
                else if ( (i == 2) || (i == 27) || (i == 28) ) {
                    movement_number = padZeros(i, 2);
                    these_notes = row['m' + movement_number + '_notes'];
                    a_pre = row['m' + movement_number + '_pre'];
                    a_post = row['m' + movement_number + '_post'];
                    document.getElementById("notes_label_" + movement_number).innerText = "Movement " + movement_number;
                    document.getElementById("notes_index_" + movement_number).innerText = a_pre + "/" + a_post;
                    document.getElementById("notes_holder_" + movement_number).innerText = these_notes;
                }
                else {
                    movement_number = padZeros(i, 2);
                    these_notes = row['m' + movement_number + '_notes'];
                    a_pre = row['m' + movement_number + 'l_pre'];
                    a_post = row['m' + movement_number + 'l_post'];
                    b_pre = row['m' + movement_number + 'r_pre'];;
                    b_post = row['m' + movement_number + 'r_post'];
                    document.getElementById("notes_label_" + movement_number).innerText = "Movement " + movement_number;
                    document.getElementById("notes_index_" + movement_number).innerText = a_pre + "/" + a_post + " " + b_pre + "/" + b_post;
                    document.getElementById("notes_holder_" + movement_number).innerText = these_notes;
                }
            }
        }
        
        function visitErrorHandler(transaction, error) {
            //console.log('visitErrorHandler.  Error was ' + error.message + ' (Code ' + error.code + ')');
            return false;
        }
        
        //setTimeout(function(){visit_db.close();}, 250);
        
    }

    
  </script>
  
  <!-- Set the event listener that signals initialisation complete. Your app can now be run. -->
  <script>
      document.addEventListener("deviceready", this.deviceready, false);
      //console.log("event listener call for deviceready");
  </script>
  
</body>
</html>
